use crate::exchange::Exchange;
use crate::order_book::{deserialize_bid_ask, BidAsk};
use anyhow::Result;
use futures_util::{SinkExt, StreamExt};
use serde::{Deserialize, Serialize};
use tokio_tungstenite::{connect_async, tungstenite::Message};
const BITSTAMP_WEB_SOCKET_URL: &str = "wss://ws.bitstamp.net/";

pub struct Bitstamp {}

impl Exchange for Bitstamp {
    fn get_name() -> String {
        "bitstamp".to_string()
    }
}

impl Bitstamp {
    pub async fn get_order_book() -> Result<()> {
        let (ws_stream, _) = connect_async(BITSTAMP_WEB_SOCKET_URL).await?;
        let (mut write, read) = ws_stream.split();

        write
            .send(Message::Text(
                BitstampSubscription::new("bts:subscribe", "order_book_btcusd").to_json(),
            ))
            .await?;

        read.for_each(|message| async {
            if let Ok(Message::Text(text)) = message {
                let response_event: BitstampResponseEvent = serde_json::from_str(&text).unwrap();
                if let BitstampWebSocketEvent::Data = response_event.event {
                    let response: BitstampResponse = serde_json::from_str(&text).unwrap();
                    println!("bitstamp response: {:#?}", response.data.bids[0]);
                }
            }
        })
        .await;

        Ok(())
    }
}

// Channel subscriptions
#[derive(Serialize)]
struct BitstampSubscriptionData {
    channel: String,
}

#[derive(Serialize)]
struct BitstampSubscription {
    event: String,
    data: BitstampSubscriptionData,
}

impl BitstampSubscription {
    fn new(event: &str, channel: &str) -> Self {
        Self {
            event: event.to_string(),
            data: BitstampSubscriptionData {
                channel: channel.to_string(),
            },
        }
    }
    fn to_json(&self) -> String {
        serde_json::to_string(self).unwrap()
    }
}

#[derive(Deserialize, Debug)]
struct BitstampResponseData {
    timestamp: String,
    microtimestamp: String,
    #[serde(deserialize_with = "deserialize_bid_ask::<'_, _, Bitstamp>")]
    bids: Vec<BidAsk>,
    #[serde(deserialize_with = "deserialize_bid_ask::<'_, _, Bitstamp>")]
    asks: Vec<BidAsk>,
}

#[derive(Deserialize, Debug)]
struct BitstampResponse {
    data: BitstampResponseData,
}

#[derive(Deserialize, Debug)]
enum BitstampWebSocketEvent {
    #[serde(rename = "bts:subscription_succeeded")]
    BtsSubscriptionSucceded,
    #[serde(rename = "data")]
    Data,
}
#[derive(Deserialize, Debug)]
struct BitstampResponseEvent {
    event: BitstampWebSocketEvent,
}

#[cfg(test)]
mod tests {
    use super::*;
    #[test]
    fn test_bitstamp_deserializer() {
        let json = r#"{
            "data": {
                "timestamp": "1681311520",
                "microtimestamp": "1681311520162799",
                "bids": [
                    ["30058", "0.73324969"],
                    ["30056", "0.14990900"],
                    ["30055", "1.36902521"],
                    ["30054", "0.05053698"],
                    ["30053", "0.10000000"],
                    ["30052", "0.45016096"],
                    ["30051", "0.90537600"],
                    ["30050", "0.44528862"],
                    ["30049", "0.10147222"],
                    ["30048", "0.33236359"],
                    ["30047", "3.55045310"],
                    ["30045", "0.34196328"],
                    ["30043", "0.09932000"],
                    ["30042", "0.00147267"],
                    ["30040", "0.20000000"],
                    ["30039", "0.00062376"],
                    ["30038", "0.00196389"],
                    ["30036", "0.20000000"],
                    ["30034", "0.00196424"],
                    ["30033", "0.21916940"],
                    ["30032", "0.41105889"],
                    ["30031", "0.00147339"],
                    ["30030", "0.20000000"],
                    ["30028", "6.59210000"],
                    ["30027", "0.00196485"],
                    ["30025", "0.20000000"],
                    ["30020", "0.00343946"],
                    ["30019", "0.20000000"],
                    ["30017", "0.00117054"],
                    ["30016", "0.00196581"],
                    ["30015", "6.77770000"],
                    ["30013", "0.00147458"],
                    ["30012", "0.20000000"],
                    ["30011", "8.05376000"],
                    ["30009", "0.00259103"],
                    ["30006", "0.20147503"],
                    ["30005", "0.30000000"],
                    ["30004", "1.61075200"],
                    ["30002", "2.62851373"],
                    ["30001", "0.80537600"],
                    ["30000", "1.09000000"],
                    ["29997", "0.80537600"],
                    ["29996", "3.64730000"],
                    ["29994", "0.00062500"],
                    ["29993", "0.80537600"],
                    ["29991", "0.00066553"],
                    ["29990", "0.80537600"],
                    ["29989", "0.20000000"],
                    ["29987", "0.00054705"],
                    ["29986", "0.80537600"],
                    ["29985", "0.20000000"],
                    ["29983", "1.15537600"],
                    ["29982", "1.26160000"],
                    ["29981", "0.00066575"],
                    ["29979", "1.00600142"],
                    ["29977", "0.01230480"],
                    ["29976", "7.35800000"],
                    ["29975", "1.00537600"],
                    ["29972", "0.00054742"],
                    ["29971", "10.48666597"],
                    ["29967", "0.07000000"],
                    ["29966", "18.49830000"],
                    ["29964", "0.00062584"],
                    ["29961", "0.20000000"],
                    ["29960", "0.00410000"],
                    ["29957", "0.20054779"],
                    ["29954", "13.70200000"],
                    ["29952", "0.20000000"],
                    ["29950", "0.06845484"],
                    ["29949", "0.00062626"],
                    ["29947", "0.20000000"],
                    ["29943", "0.20000000"],
                    ["29942", "4.15548310"],
                    ["29941", "0.07000000"],
                    ["29938", "0.00066671"],
                    ["29937", "0.36000000"],
                    ["29936", "0.20000000"],
                    ["29931", "0.20066686"],
                    ["29926", "0.20000000"],
                    ["29920", "0.20066711"],
                    ["29915", "0.00552577"],
                    ["29914", "0.20000000"],
                    ["29911", "0.00668650"],
                    ["29907", "0.00066740"],
                    ["29904", "2.38470000"],
                    ["29901", "0.00086954"],
                    ["29900", "0.05000000"],
                    ["29888", "7.91990000"],
                    ["29884", "0.00615714"],
                    ["29878", "0.00066805"],
                    ["29875", "14.73800000"],
                    ["29872", "0.00066818"],
                    ["29865", "0.06261510"],
                    ["29860", "0.00420000"],
                    ["29858", "0.03000000"],
                    ["29855", "0.10000000"],
                    ["29852", "0.00066997"],
                    ["29850", "0.56065888"],
                    ["29833", "0.01000000"],
                    ["29830", "0.04000000"]
                ],
                "asks": [
                    ["30059", "0.66465771"],
                    ["30062", "0.00655094"],
                    ["30063", "0.68718996"],
                    ["30064", "0.49908833"],
                    ["30066", "0.10000000"],
                    ["30067", "0.20000000"],
                    ["30068", "0.33943000"],
                    ["30069", "0.10000000"],
                    ["30070", "0.37646230"],
                    ["30071", "0.59890407"],
                    ["30072", "1.36160000"],
                    ["30073", "0.24122781"],
                    ["30074", "0.10000000"],
                    ["30075", "0.19000000"],
                    ["30076", "0.10000000"],
                    ["30077", "1.55830368"],
                    ["30080", "0.00066000"],
                    ["30081", "0.20000000"],
                    ["30083", "2.38470000"],
                    ["30085", "0.20000000"],
                    ["30089", "3.22930000"],
                    ["30090", "0.20000000"],
                    ["30093", "3.07040000"],
                    ["30095", "0.20000000"],
                    ["30101", "0.20000000"],
                    ["30103", "0.01232755"],
                    ["30104", "0.01412063"],
                    ["30105", "0.20534299"],
                    ["30106", "3.17020000"],
                    ["30109", "0.20000000"],
                    ["30113", "0.20000000"],
                    ["30116", "0.00559451"],
                    ["30117", "3.17800000"],
                    ["30118", "0.20000000"],
                    ["30122", "0.29469821"],
                    ["30123", "4.00730000"],
                    ["30129", "0.20000000"],
                    ["30134", "0.20000000"],
                    ["30135", "6.24130000"],
                    ["30136", "3.15430000"],
                    ["30138", "0.20000000"],
                    ["30145", "0.20000000"],
                    ["30149", "0.20000000"],
                    ["30155", "0.20000000"],
                    ["30157", "7.31600000"],
                    ["30160", "0.20000000"],
                    ["30161", "18.29830000"],
                    ["30165", "0.20000000"],
                    ["30170", "0.20000000"],
                    ["30173", "0.50000000"],
                    ["30174", "0.20000000"],
                    ["30177", "3.20550000"],
                    ["30180", "0.20000000"],
                    ["30182", "0.82000000"],
                    ["30184", "0.20000000"],
                    ["30188", "0.20000000"],
                    ["30192", "0.20000000"],
                    ["30200", "0.04470081"],
                    ["30212", "0.01108312"],
                    ["30220", "13.88761889"],
                    ["30227", "0.00054136"],
                    ["30231", "10.28600000"],
                    ["30235", "0.00061848"],
                    ["30243", "0.00061826"],
                    ["30250", "0.00054081"],
                    ["30258", "0.00061785"],
                    ["30264", "14.63300000"],
                    ["30265", "0.00054045"],
                    ["30273", "0.00061745"],
                    ["30277", "0.00194348"],
                    ["30280", "0.00199744"],
                    ["30283", "8.71990000"],
                    ["30284", "0.00194281"],
                    ["30286", "0.80000000"],
                    ["30288", "0.00255951"],
                    ["30290", "0.80000000"],
                    ["30291", "0.00145665"],
                    ["30294", "0.80000000"],
                    ["30295", "0.00194187"],
                    ["30296", "0.00061682"],
                    ["30297", "0.80000000"],
                    ["30299", "0.00194154"],
                    ["30300", "0.16900192"],
                    ["30301", "0.80000000"],
                    ["30302", "0.00145594"],
                    ["30303", "0.00053955"],
                    ["30304", "0.80000000"],
                    ["30306", "0.00194093"],
                    ["30308", "0.80000000"],
                    ["30310", "0.00194059"],
                    ["30311", "0.00061641"],
                    ["30312", "0.80000000"],
                    ["30313", "0.00145524"],
                    ["30315", "0.80000000"],
                    ["30317", "0.00194000"],
                    ["30318", "0.00053919"],
                    ["30319", "0.80000000"],
                    ["30320", "0.00145479"],
                    ["30323", "0.80000000"],
                    ["30324", "0.00193940"]
                ]
            },
            "channel": "order_book_btcusd",
            "event": "data"
        }"#;
        let response: BitstampResponse = serde_json::from_str(json).unwrap();
        dbg!(response);
    }
}

use crate::exchange::Exchange;
use crate::order_book::{OrderBook, OrderBookBuilder};
use futures_util::{SinkExt, StreamExt};
use serde::{Deserialize, Serialize};
use tokio::sync::mpsc::UnboundedSender;
use tokio_tungstenite::{connect_async, tungstenite::Message};

#[cfg(not(test))]
const BITSTAMP_WEB_SOCKET_URL: &str = "wss://ws.bitstamp.net/";

#[cfg(test)]
const BITSTAMP_WEB_SOCKET_URL: &str = "ws://localhost:8081/ws/";

#[derive(Debug, Deserialize)]
pub struct Bitstamp;

#[tonic::async_trait]
impl Exchange for Bitstamp {
    fn get_name() -> &'static str {
        "bitstamp"
    }
    async fn get_order_book(pair: &str, sender: UnboundedSender<OrderBook>) -> () {
        let (ws_stream, _) = connect_async(BITSTAMP_WEB_SOCKET_URL).await.unwrap();
        let (mut write, read) = ws_stream.split();

        write
            .send(Message::Text(
                BitstampSubscription::new("bts:subscribe", format!("order_book_{}", pair))
                    .to_json(),
            ))
            .await
            .unwrap();

        read.for_each(|message| async {
            if let Ok(Message::Text(text)) = message {
                let response_event: BitstampResponseEvent = serde_json::from_str(&text).unwrap();
                if let BitstampWebSocketEvent::Data = response_event.event {
                    let bitstamp_response: BitstampResponse = serde_json::from_str(&text).unwrap();
                    let order_book: OrderBookBuilder<Bitstamp> = bitstamp_response.into();
                    sender.send(order_book.build()).unwrap();
                }
            }
        })
        .await;
    }
}

// Channel subscriptions
#[derive(Serialize)]
struct BitstampSubscriptionData {
    channel: String,
}

#[derive(Serialize)]
struct BitstampSubscription {
    event: String,
    data: BitstampSubscriptionData,
}

impl BitstampSubscription {
    fn new(event: &str, channel: String) -> Self {
        Self {
            event: event.to_string(),
            data: BitstampSubscriptionData { channel },
        }
    }
    fn to_json(&self) -> String {
        serde_json::to_string(self).unwrap()
    }
}

#[derive(Deserialize, Debug)]
struct BitstampResponse {
    data: OrderBookBuilder<Bitstamp>,
}

impl From<BitstampResponse> for OrderBookBuilder<Bitstamp> {
    fn from(bitstamp_response: BitstampResponse) -> Self {
        bitstamp_response.data
    }
}

#[derive(Deserialize, Debug)]
enum BitstampWebSocketEvent {
    #[serde(rename = "bts:subscription_succeeded")]
    BtsSubscriptionSucceded,
    #[serde(rename = "data")]
    Data,
}
#[derive(Deserialize, Debug)]
struct BitstampResponseEvent {
    event: BitstampWebSocketEvent,
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::test_server::TestServer;
    use tokio::spawn;
    #[tokio::test]
    async fn test_bitstamp_websocket() {
        let mut server = TestServer::new("8081").await;
        let (sender, mut receiver) = server.get_channels();

        spawn(Bitstamp::get_order_book("ethbtc", sender));

        server.send_message("{\"data\":{\"timestamp\":\"1682167286\",\"microtimestamp\":\"1682167286795358\",\"bids\":[[\"0.06791795\",\"0.44453153\"],[\"0.06790535\",\"0.40000000\"],[\"0.06790534\",\"0.55000000\"],[\"0.06790467\",\"0.40000000\"],[\"0.06790466\",\"0.40000000\"],[\"0.06789815\",\"0.80841402\"],[\"0.06789754\",\"0.40000000\"],[\"0.06789753\",\"0.55000000\"],[\"0.06789065\",\"0.40000000\"],[\"0.06789064\",\"0.55000000\"],[\"0.06788955\",\"1.34755666\"],[\"0.06788578\",\"0.40000000\"],[\"0.06788330\",\"0.55000000\"],[\"0.06787416\",\"6.53690684\"],[\"0.06787415\",\"0.55000000\"],[\"0.06787120\",\"1.13580060\"],[\"0.06786890\",\"0.45586860\"],[\"0.06786563\",\"0.55000000\"],[\"0.06786467\",\"2.69612070\"],[\"0.06785605\",\"4.04522114\"],[\"0.06785600\",\"0.55000000\"],[\"0.06785000\",\"6.18100000\"],[\"0.06784307\",\"0.55000000\"],[\"0.06784209\",\"4.19878778\"],[\"0.06783608\",\"0.55000000\"],[\"0.06783000\",\"19.41630000\"],[\"0.06782702\",\"0.55000000\"],[\"0.06781886\",\"0.55000000\"],[\"0.06781172\",\"0.55000000\"],[\"0.06780153\",\"0.55000000\"],[\"0.06780000\",\"36.81900000\"],[\"0.06779345\",\"5.40083113\"],[\"0.06779298\",\"0.55000000\"],[\"0.06778367\",\"0.55000000\"],[\"0.06777600\",\"0.55000000\"],[\"0.06776730\",\"2.29751940\"],[\"0.06776651\",\"0.55000000\"],[\"0.06775508\",\"0.55000000\"],[\"0.06774828\",\"0.55000000\"],[\"0.06774420\",\"0.00299216\"],[\"0.06774150\",\"0.55000000\"],[\"0.06773468\",\"0.55000000\"],[\"0.06772656\",\"0.00299213\"],[\"0.06772419\",\"0.55000000\"],[\"0.06771495\",\"0.55000000\"],[\"0.06770892\",\"0.00299210\"],[\"0.06770537\",\"0.55000000\"],[\"0.06769402\",\"0.55000000\"],[\"0.06769300\",\"19.20000000\"],[\"0.06769128\",\"0.00299207\"],[\"0.06768509\",\"0.55000000\"],[\"0.06767952\",\"0.00299205\"],[\"0.06767364\",\"0.00299204\"],[\"0.06766188\",\"0.00300202\"],[\"0.06765600\",\"0.00300201\"],[\"0.06764903\",\"8.00647980\"],[\"0.06764424\",\"0.00300199\"],[\"0.06763836\",\"0.00300198\"],[\"0.06762660\",\"0.00300196\"],[\"0.06762072\",\"0.00300195\"],[\"0.06761161\",\"0.02553348\"],[\"0.06761160\",\"36.20000000\"],[\"0.06760896\",\"0.00300193\"],[\"0.06760308\",\"0.00300192\"],[\"0.06760000\",\"3.00000000\"],[\"0.06759132\",\"0.00300190\"],[\"0.06758544\",\"0.00300189\"],[\"0.06757368\",\"0.00300187\"],[\"0.06756780\",\"0.00300186\"],[\"0.06755604\",\"0.00300184\"],[\"0.06755016\",\"0.00300183\"],[\"0.06753840\",\"0.00300181\"],[\"0.06753252\",\"0.00300180\"],[\"0.06752595\",\"4.49720040\"],[\"0.06752076\",\"0.00300178\"],[\"0.06751488\",\"0.00300177\"],[\"0.06750312\",\"0.00300175\"],[\"0.06749724\",\"0.00300174\"],[\"0.06748548\",\"0.00300172\"],[\"0.06747960\",\"0.00300171\"],[\"0.06747372\",\"0.00300170\"],[\"0.06746784\",\"0.00300169\"],[\"0.06746620\",\"38.10000000\"],[\"0.06746196\",\"0.00300168\"],[\"0.06745608\",\"0.00300167\"],[\"0.06745020\",\"0.00300166\"],[\"0.06744432\",\"0.00301165\"],[\"0.06743844\",\"0.00301164\"],[\"0.06743256\",\"0.00301163\"],[\"0.06742668\",\"0.00301162\"],[\"0.06742080\",\"0.00301161\"],[\"0.06741492\",\"0.00301160\"],[\"0.06740904\",\"0.00301159\"],[\"0.06740316\",\"0.00301158\"],[\"0.06740068\",\"3.46529700\"],[\"0.06739728\",\"0.00301157\"],[\"0.06739140\",\"0.00301156\"],[\"0.06738552\",\"0.00301155\"],[\"0.06737964\",\"0.00301154\"],[\"0.06737376\",\"0.00301153\"]],\"asks\":[[\"0.06792853\",\"0.55000000\"],[\"0.06792858\",\"0.40000000\"],[\"0.06793198\",\"0.20000000\"],[\"0.06793538\",\"0.55000000\"],[\"0.06793705\",\"0.80795120\"],[\"0.06794253\",\"0.40000000\"],[\"0.06794333\",\"0.40000000\"],[\"0.06794334\",\"0.55000000\"],[\"0.06794520\",\"1.34647060\"],[\"0.06795205\",\"0.55000000\"],[\"0.06795885\",\"0.55000000\"],[\"0.06796665\",\"0.55000000\"],[\"0.06796730\",\"0.40000000\"],[\"0.06797511\",\"0.55000000\"],[\"0.06797718\",\"2.69199156\"],[\"0.06798361\",\"0.55000000\"],[\"0.06798792\",\"0.29670000\"],[\"0.06799249\",\"0.55000000\"],[\"0.06799996\",\"0.55000000\"],[\"0.06800160\",\"0.45586860\"],[\"0.06800802\",\"0.55000000\"],[\"0.06800967\",\"4.03479653\"],[\"0.06801000\",\"5.65890000\"],[\"0.06802079\",\"0.55000000\"],[\"0.06802758\",\"0.55000000\"],[\"0.06803437\",\"0.55000000\"],[\"0.06804039\",\"5.38013230\"],[\"0.06804100\",\"1.13580060\"],[\"0.06804399\",\"0.55000000\"],[\"0.06805000\",\"16.42850000\"],[\"0.06805739\",\"0.55000000\"],[\"0.06807085\",\"8.55549130\"],[\"0.06807086\",\"0.55000000\"],[\"0.06807823\",\"0.55000000\"],[\"0.06808000\",\"33.14500000\"],[\"0.06808550\",\"2.29751940\"],[\"0.06808712\",\"0.55000000\"],[\"0.06809769\",\"0.55000000\"],[\"0.06810084\",\"0.00299219\"],[\"0.06810457\",\"0.55000000\"],[\"0.06810942\",\"8.00647980\"],[\"0.06811163\",\"0.55000000\"],[\"0.06811848\",\"0.00299222\"],[\"0.06812385\",\"0.55000000\"],[\"0.06813036\",\"0.00300173\"],[\"0.06813065\",\"0.55000000\"],[\"0.06813612\",\"0.00299225\"],[\"0.06813616\",\"0.00299208\"],[\"0.06813808\",\"0.55000000\"],[\"0.06814711\",\"0.55000000\"],[\"0.06814800\",\"0.00300176\"],[\"0.06815376\",\"0.00299228\"],[\"0.06815380\",\"0.00299211\"],[\"0.06815391\",\"0.55000000\"],[\"0.06816254\",\"0.55000000\"],[\"0.06816564\",\"0.00300179\"],[\"0.06817000\",\"0.01900000\"],[\"0.06817140\",\"0.00598462\"],[\"0.06817144\",\"0.00299214\"],[\"0.06818328\",\"0.00300182\"],[\"0.06818737\",\"4.49720040\"],[\"0.06818904\",\"0.00299234\"],[\"0.06818908\",\"0.00299217\"],[\"0.06820092\",\"0.00300185\"],[\"0.06820668\",\"0.00299237\"],[\"0.06820672\",\"0.00299220\"],[\"0.06821856\",\"0.00300188\"],[\"0.06822432\",\"0.00299240\"],[\"0.06822436\",\"0.00299223\"],[\"0.06823620\",\"0.00300191\"],[\"0.06824196\",\"0.00298243\"],[\"0.06824200\",\"0.00299226\"],[\"0.06825384\",\"0.00300194\"],[\"0.06825960\",\"0.00298246\"],[\"0.06825964\",\"0.00299229\"],[\"0.06827148\",\"0.00300197\"],[\"0.06827724\",\"0.00298249\"],[\"0.06827728\",\"0.00598464\"],[\"0.06828912\",\"0.00300200\"],[\"0.06829488\",\"0.00298252\"],[\"0.06829492\",\"0.02934863\"],[\"0.06830300\",\"0.23009231\"],[\"0.06830676\",\"0.00300203\"],[\"0.06831252\",\"0.00298255\"],[\"0.06831256\",\"0.00299238\"],[\"0.06832440\",\"0.00299206\"],[\"0.06833016\",\"0.00298258\"],[\"0.06833020\",\"0.00299241\"],[\"0.06834204\",\"0.00299209\"],[\"0.06834780\",\"0.00298261\"],[\"0.06834784\",\"0.00298244\"],[\"0.06835968\",\"0.00299212\"],[\"0.06836544\",\"0.00298264\"],[\"0.06836548\",\"0.00298247\"],[\"0.06837149\",\"3.46529700\"],[\"0.06837732\",\"0.00299215\"],[\"0.06838308\",\"0.00298267\"],[\"0.06838312\",\"0.00298250\"],[\"0.06839496\",\"0.00299218\"],[\"0.06840072\",\"0.00298270\"]]},\"channel\":\"order_book_ethbtc\",\"event\":\"data\"}");

        if let Some(order_book) = receiver.recv().await {
            assert_eq!(order_book.get_exchange_name(), "bitstamp");
            let (bids, asks) = order_book.get_levels();

            assert_eq!(bids.len(), 10);
            assert_eq!(asks.len(), 10);

            // highest price first for bids
            assert_eq!(bids[0].price, 0.06791795);
            assert_eq!(bids[9].price, 0.06789064);

            // lowest price first for asks
            assert_eq!(asks[0].price, 0.06792853);
            assert_eq!(asks[9].price, 0.06795205);
        }
    }
}
